<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/x-icon" href="./favicon.ico">
  <link rel="stylesheet" href="style.css">
  <title>YouTube Video Downloader</title>
</head>
<body>

	<h1>YouTube Downloader</h1>

	<div class="mainContents">

	  <!-- Options Panel (Left Side) -->
	  <div class="options">
	    <input id="url" type="text" placeholder="URL do vídeo">

	    <select id="format">
	      <option value="mp4">MP4</option>
	      <option value="mp3">MP3</option>
	    </select>

	    <select id="vid-resolution" style="display: none;">
	      <option value="1080p">1080p</option>
	      <option value="720p">720p</option>
	      <option value="480p">480p</option>
	    </select>
	    <select id="aud-resolution" style="display: none;">
	      <option value="0">Melhor Qualidade</option>
	      <option value="5">Média Qualidade</option>
	      <option value="10">Pior Qualidade</option>
	    </select>

	    <select id="path">
	      <option value="./public/downloads">Baixar no site</option>
	      <option value="$HOME/musicas">$HOME/musicas</option>
	    </select>

	    <button onclick="post()">Enviar</button>
	  </div>

	  <!-- Video Panel (Right Side) -->
	  <div class="videoDownloaded">
	    <!-- Placeholder for Thumbnail -->
	    <div id="thumbnail-placeholder">
	      <img src="NO_VIDEO_SUBMITED.png" id="thumbnail" alt="Thumbnail Preview" />
	      <p id="videoWarning" style="display: none;">O vídeo ou playlist foi baixado com sucesso!</p>
	    </div>
	    

	    <!-- Placeholder for Download Button -->
	    <div id="download-placeholder">
	      <button id="downloadButt" onclick="download(blobLink)" style="display: none;">
		Baixar
	      </button>
	    </div>
	  </div>

	</div>


	<script>		
	
		const url = document.getElementById("url");
		const format = document.getElementById("format");
		const quality = document.getElementById("resolutions");
		const path = document.getElementById("path");
		const thumbnail = document.getElementById("thumbnail");
		const musicasWarning = document.getElementById("musicasWarning");
		const downloadButt = document.getElementById("downloadButt");
		let blobLink = "";
		let resolutions = ""; // defiened in getFormat();

		function returnIndex(url){
			
			// retorna o valor do index
			const match = url.match(/&index=(\d+)/);
			// returns a string bcuz server works
			// with strings :3
			return match ? match[1] : "null";
		}

		function isPlaylist(url){
			const match = url.match(/list=*/);
			// same as index but returns those
			return match ? "true" : "false";
		}

		async function post(){
			
			const urlValue = url.value;
			const formatValue = format.options[format.selectedIndex].value;
			const qualityValue = resolutions.options[resolutions.selectedIndex].value;
			const pathValue = path.options[path.selectedIndex].value;
			const index = returnIndex(urlValue);
			const isPlaylistUrl = isPlaylist(urlValue);

			const res = await fetch(`${window.location.href}video`, {
				method:"post",
				headers: {
					"Content-Type": "application/json",
				},
				body: JSON.stringify({
					urlValue, 
					formatValue,
					qualityValue,
					pathValue,
					index,
					isPlaylistUrl,
				}),
			});

			const blob = await res.blob();
			/*
			thumbnail.src = "./downloads/video.webp";
			thumbnail.style.display = "block";
			*/

			const thumbnailFetch = await fetch(`${window.location.href}thumbnail`, {
				method: "GET",
			});
		
			thumbnail.style.display = "flex";

			if(pathValue == "./public/downloads"){
				const thumbnailsrc = await thumbnailFetch.blob();
				thumbnail.src = URL.createObjectURL(thumbnailsrc);
				downloadButt.style.display = "flex";
				const file = URL.createObjectURL(blob);
				blobLink = file;

			} else {
				musicasWarning.style = "display: flex;";
			}
		}

		function download(url){
		          const a = document.createElement('a');
	              	  a.href = url;				  
			  a.download = url.split('/').pop();
			  document.body.appendChild(a);
			  a.click();
			  document.body.removeChild(a);
		}

		format.addEventListener("click", getFormat, false);
		function getFormat() {
			resolutions.style="display:none";

			switch(format.options[format.selectedIndex ].value){
				case("mp4"):

					resolutions = document.getElementById("vid-resolution");
					break;
				case("mp3"):

					resolutions = document.getElementById("aud-resolution");
					break;
			}

			resolutions.style="display:flex";
		}
		getFormat();

	</script>
</body>
</html>

